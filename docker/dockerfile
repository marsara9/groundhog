FROM python:3-slim
# Install required software
RUN apt-get update
RUN apt-get install -y \
    net-tools \
    network-manager \
    wireguard \
    build-essential \
    curl
#RUN systemctl enable NetworkManager.service

# Create driectory structure
WORKDIR /router
RUN bash -c 'mkdir -p database/{users,config}'
COPY ui/ ui/
COPY server/ server/

# Setup user and permissions
ENV HOME /root
#RUN useradd -m dockeruser
#RUN usermod -aG sudo dockeruser
#RUN chown -R dockeruser /router
#USER dockeruser
#ENV HOME /home/dockeruser

# Install user specific software
## Rust is required by bcrypt
RUN curl https://sh.rustup.rs -sSf | bash -s -- -y --profile minimal
ENV PATH="${HOME}/.cargo/bin:${PATH}"
RUN pip3 install simplejson bcrypt nmcli --verbose --no-warn-script-location

# Start the server
EXPOSE 8080
ENTRYPOINT ["python3", "-u", "server/vpnrouter.py"]
